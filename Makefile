# Makefile for version release management

# Default module to release
MODULE ?= archytas
PROTO_DIRS := eupalinos
TOOLS_DIR := $(PWD)/.bin
PROTOC_GEN_DOC := $(TOOLS_DIR)/protoc-gen-doc

# Get the latest version tag for the specified module
.PHONY: get-latest-version
get-latest-version:
	@echo "Getting latest version for $(MODULE)..."
	@latest_tag=$$(git tag -l "$(MODULE)/v*" | sort -V | tail -n 1); \
	if [ -z "$$latest_tag" ]; then \
		echo "No existing tags found for $(MODULE), using v0.1.0 as base"; \
		echo "$(MODULE)/v0.1.0"; \
	else \
		echo "Latest version: $$latest_tag"; \
	fi

# Release a new patch version (e.g., v0.1.2 -> v0.1.3)
.PHONY: release-patch
release-patch:
	@echo "Releasing new patch version for $(MODULE)..."
	@latest_tag=$$(git tag -l "$(MODULE)/v*" | sort -V | tail -n 1); \
	if [ -z "$$latest_tag" ]; then \
		new_tag="$(MODULE)/v0.1.0"; \
		echo "No existing tags found for $(MODULE), using $$new_tag as first version"; \
	else \
		version=$$(echo $$latest_tag | sed 's/$(MODULE)\/v//'); \
		major=$$(echo $$version | cut -d. -f1); \
		minor=$$(echo $$version | cut -d. -f2); \
		patch=$$(echo $$version | cut -d. -f3); \
		new_patch=$$((patch + 1)); \
		new_tag="$(MODULE)/v$$major.$$minor.$$new_patch"; \
		echo "Incrementing patch version: $$latest_tag -> $$new_tag"; \
	fi; \
	git tag $$new_tag && git push origin $$new_tag; \
	echo "Released: $$new_tag"

# Release a new minor version (e.g., v0.1.2 -> v0.2.0)
.PHONY: release-minor
release-minor:
	@echo "Releasing new minor version for $(MODULE)..."
	@latest_tag=$$(git tag -l "$(MODULE)/v*" | sort -V | tail -n 1); \
	if [ -z "$$latest_tag" ]; then \
		new_tag="$(MODULE)/v0.1.0"; \
		echo "No existing tags found for $(MODULE), using $$new_tag as first version"; \
	else \
		version=$$(echo $$latest_tag | sed 's/$(MODULE)\/v//'); \
		major=$$(echo $$version | cut -d. -f1); \
		minor=$$(echo $$version | cut -d. -f2); \
		new_minor=$$((minor + 1)); \
		new_tag="$(MODULE)/v$$major.$$new_minor.0"; \
		echo "Incrementing minor version: $$latest_tag -> $$new_tag"; \
	fi; \
	git tag $$new_tag && git push origin $$new_tag; \
	echo "Released: $$new_tag"

# Release a new major version (e.g., v0.1.2 -> v1.0.0)
.PHONY: release-major
release-major:
	@echo "Releasing new major version for $(MODULE)..."
	@latest_tag=$$(git tag -l "$(MODULE)/v*" | sort -V | tail -n 1); \
	if [ -z "$$latest_tag" ]; then \
		new_tag="$(MODULE)/v1.0.0"; \
		echo "No existing tags found for $(MODULE), using $$new_tag as first version"; \
	else \
		version=$$(echo $$latest_tag | sed 's/$(MODULE)\/v//'); \
		major=$$(echo $$version | cut -d. -f1); \
		new_major=$$((major + 1)); \
		new_tag="$(MODULE)/v$$new_major.0.0"; \
		echo "Incrementing major version: $$latest_tag -> $$new_tag"; \
	fi; \
	git tag $$new_tag && git push origin $$new_tag; \
	echo "Released: $$new_tag"

.PHONY: generate
generate:
	@for dir in $(PROTO_DIRS); do \
		echo "Generating Protobuf files in $$dir..."; \
		(cd $$dir && \
		 protoc --go_out=. --go_opt=paths=source_relative \
		        --go-grpc_out=. --go-grpc_opt=paths=source_relative \
		        proto/$$dir.proto); \
	done

	@for dir in $(PROTO_DIRS_NEW); do \
		echo "Generating Protobuf files in $$dir..."; \
		buf generate --template $$dir/buf.gen.yaml $$dir; \
	done

.PHONY: tools
tools: $(PROTOC_GEN_DOC)

$(PROTOC_GEN_DOC):
	@mkdir -p $(TOOLS_DIR)
	@echo "Installing protoc-gen-doc..."
	@GOBIN=$(TOOLS_DIR) go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@latest


.PHONY: docs
docs: tools
	@for dir in $(PROTO_DIRS); do \
		echo "Generating gRPC docs in $$dir..."; \
		PATH=$(TOOLS_DIR):$$PATH buf generate --template $$dir/buf.gen.docs.yaml $$dir; \
	done


# Help command
.PHONY: help
help:
	@echo "Usage:"
	@echo "  make get-latest-version [MODULE=module_name]  - Get the latest version for a module"
	@echo "  make release-patch [MODULE=module_name]       - Release a new patch version (x.y.z -> x.y.z+1)"
	@echo "  make release-minor [MODULE=module_name]       - Release a new minor version (x.y.z -> x.y+1.0)"
	@echo "  make release-major [MODULE=module_name]       - Release a new major version (x.y.z -> x+1.0.0)"
	@echo ""
	@echo "Examples:"
	@echo "  make release-patch MODULE=archytas            - Release a new patch version for archytas"
	@echo "  make release-minor MODULE=plato               - Release a new minor version for plato"
	@echo ""
	@echo "If MODULE is not specified, 'archytas' is used as the default."